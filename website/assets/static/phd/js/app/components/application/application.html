<form role="form" ng-submit="vm.uploadNewApplication()">

    <div ng-show="vm.newApplication" align="center">
        <h1>New Application</h1>
    </div>

    <div ng-show="!vm.newApplication" align="center">
        <h1>Edit Application: <i>{{ vm.application.registry_ref }}</i></h1>
        <span>Last modified at {{ vm.application.modified_at  | date : 'dd-MM-yyyy'}}</span>
    </div>

    <h3>Basic Details</h3>

    <div class="media col-lg-12">
        <label class="col-lg-2" for="registryRef">Registry Reference Number</label>
        <div class="col-lg-10">
            <input type="text" class="form-control" id="registryRef" ng-model="vm.application.registry_ref" placeholder="E.g. 07362354" required>
        </div>
    </div>

    <div class="media col-lg-12">
        <label class="col-lg-2" for="surname">Surname</label>
        <div class="col-lg-10">
            <input type="text" class="form-control" id="surname" ng-model="vm.application.surname" placeholder="E.g. Szeles" required>
        </div>
    </div>

    <div class="media col-lg-12">
        <label class="col-lg-2" for="forename">Forename</label>
        <div class="col-lg-10">
            <input type="text" class="form-control" id="forename" ng-model="vm.application.forename" placeholder="E.g. Marton" required>
        </div>
    </div>

    <div class="media col-lg-12">
        <label class="col-lg-2" for="possibleFunding">Possible Funding</label>
        <div class="col-lg-10">
            <select class="form-control" id="possibleFunding" ng-model="vm.application.possible_funding" required>
                <option value="" disabled selected>Please select...</option>
                <option ng-repeat="(key, value) in vm.applicationFieldChoices['possible_funding']" value="{{key}}">{{value}}</option>
            </select>
        </div>
    </div>

    <div class="media col-lg-12">
        <label class="col-lg-2" for="fundingStatus">Funding Status</label>
        <div class="col-lg-10">
            <select class="form-control" id="fundingStatus" ng-model="vm.application.funding_status" required>
                <option value="" disabled selected>Please select...</option>
                <option ng-repeat="(key, value) in vm.applicationFieldChoices['funding_status']" value="{{key}}">{{value}}</option>
            </select>
        </div>
    </div>

    <div class="media col-lg-12">
        <label class="col-lg-2" for="origin">Origin (Fee Classification)</label>
        <div class="col-lg-10">
            <select class="form-control" id="origin" ng-model="vm.application.origin" required>
                <option value="" disabled selected>Please select...</option>
                <option ng-repeat="(key, value) in vm.applicationFieldChoices['origin']" value="{{key}}">{{value}}</option>
            </select>
        </div>
    </div>

    <div class="media col-lg-12">
        <label class="col-lg-2" for="studentType">Student Type</label>
        <div class="col-lg-10">
            <select class="form-control" id="studentType" ng-model="vm.application.student_type" required>
                <option value="" disabled selected>Please select...</option>
                <option ng-repeat="(key, value) in vm.applicationFieldChoices['student_type']" value="{{key}}">{{value}}</option>
            </select>
        </div>
    </div>

    <div class="media col-lg-12" ng-show="!vm.newApplication">
        <label class="col-lg-2" for="status">Status</label>
        <div class="col-lg-10">
            <select class="form-control" id="status" ng-model="vm.application.status">
                <option value="" disabled selected>Please select...</option>
                <option ng-repeat="(key, value) in vm.applicationFieldChoices['status']" value="{{key}}">{{value}}</option>
            </select>
        </div>
    </div>

    <h3>Documentation</h3>

    <div class="table-responsive">

        <table class="table table-striped table-bordered table-condensed table-hover file-table">
            <thead>
                <tr>
                    <th>File Type</th>
                    <th>File Name</th>
                    <th>Description</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody>

                <!-- Application Form -->
                <tr ng-show="vm.creatorSupervisionFiles['APPLICATION_FORM'].length === 0">
                    <td>
                        <h4>
                            Application Form
                        </h4>
                    </td>
                    <td>
                        <div class="input-group">
                            <label class="input-group-btn">
                                <span class="btn btn-primary">
                                    Browse&hellip; <input type="file" style="display: none;" name="APPLICATION_FORM" id="0" onchange="angular.element(this).scope().setFiles(this)">
                                </span>
                            </label>
                            <input type="text" class="form-control" ng-value="vm.newFilesIndex['APPLICATION_FORM'][0]['file']['name']" readonly>
                        </div>
                    </td>
                    <td>
                        <input type="text" ng-model="vm.newFilesIndex['APPLICATION_FORM'][0]['description']" class="form-control">
                    </td>
                    <td align="center">
                        <button type="button" class="btn btn-sm btn-primary" ng-show="vm.newFilesIndex['APPLICATION_FORM'][0]['file'] != undefined && !vm.newApplication" ng-click="vm.uploadFile(0, 'APPLICATION_FORM')">Upload</button>
                    </td>
                </tr>


                <tr ng-show="vm.creatorSupervisionFiles['APPLICATION_FORM'].length !== 0">
                    <td>
                        <h4>
                            Application Form
                        </h4>
                    </td>
                    <td>
                        <a target="_blank" href="api/applications/download/?id={{ vm.creatorSupervisionFiles.APPLICATION_FORM[0].id }}&token={{ vm.access_token }}"> {{ vm.creatorSupervisionFiles.APPLICATION_FORM[0].file_name }} </a>
                    </td>
                    <td>
                        <input type="text" ng-model="vm.creatorSupervisionFiles['APPLICATION_FORM'][0]['description']" class="form-control" readonly>
                    </td>
                    <td align="center">
                        <button class="btn btn-danger btn-sm"
                            type="button"
                            mwl-confirm
                            title="Delete File"
                            message="Permanently delete <b>{{ vm.creatorSupervisionFiles.APPLICATION_FORM[0].file_name }}</b>?"
                            confirm-text="Yes"
                            cancel-text="Cancel"
                            placement="top"
                            on-confirm="vm.deleteFile('APPLICATION_FORM', vm.creatorSupervisionFiles.APPLICATION_FORM[0].id)"
                            confirm-button-type="danger"
                            cancel-button-type="default">Remove</button>
                    </td>
                </tr>


                <!-- Research Summary -->
                <tr ng-show="vm.creatorSupervisionFiles['RESEARCH_SUMMARY'].length === 0">
                    <td>
                        <h4>
                            Research Summary
                        </h4>
                    </td>
                    <td>
                        <div class="input-group">
                            <label class="input-group-btn">
                                <span class="btn btn-primary">
                                    Browse&hellip; <input type="file" style="display: none;" name="RESEARCH_SUMMARY" id="0" onchange="angular.element(this).scope().setFiles(this)">
                                </span>
                            </label>
                            <input type="text" class="form-control" ng-value="vm.newFilesIndex['RESEARCH_SUMMARY'][0]['file']['name']" readonly>
                        </div>
                    </td>
                    <td>
                        <input type="text" ng-model="vm.newFilesIndex['RESEARCH_SUMMARY'][0]['description']" class="form-control">
                    </td>
                    <td align="center">
                        <button type="button" class="btn btn-sm btn-primary" ng-show="vm.newFilesIndex['RESEARCH_SUMMARY'][0]['file'] != undefined && !vm.newApplication" ng-click="vm.uploadFile(0, 'RESEARCH_SUMMARY')">Upload</button>
                    </td>
                </tr>

                <tr ng-show="vm.creatorSupervisionFiles['RESEARCH_SUMMARY'].length !== 0">
                    <td>
                        <h4>
                            Research Summary
                        </h4>
                    </td>
                    <td>
                        <a target="_blank" href="api/applications/download/?id={{ vm.creatorSupervisionFiles.RESEARCH_SUMMARY[0].id }}&token={{ vm.access_token }}"> {{ vm.creatorSupervisionFiles.RESEARCH_SUMMARY[0].file_name }} </a>
                    </td>
                    <td>
                        <input type="text" ng-model="vm.creatorSupervisionFiles['RESEARCH_SUMMARY'][0]['description']" class="form-control" readonly>
                    </td>
                    <td align="center">
                        <button class="btn btn-danger btn-sm"
                            type="button"
                            mwl-confirm
                            title="Delete File"
                            message="Permanently delete <b>{{ vm.creatorSupervisionFiles.RESEARCH_SUMMARY[0].file_name }}</b>?"
                            confirm-text="Yes"
                            cancel-text="Cancel"
                            placement="top"
                            on-confirm="vm.deleteFile('RESEARCH_SUMMARY', vm.creatorSupervisionFiles.RESEARCH_SUMMARY[0].id)"
                            confirm-button-type="danger"
                            cancel-button-type="default">Remove</button>
                    </td>
                </tr>


                <!-- Reference -->
                <tr ng-repeat="additional in vm.creatorSupervisionFiles['REFERENCE'] track by additional.id">
                    <td>
                        <h4>
                            Reference {{ $index + 1 }}
                        </h4>
                    </td>
                    <td>
                        <a target="_blank" href="api/applications/download/?id={{ additional.id }}&token={{ vm.access_token }}"> {{ additional.file_name }} </a>
                    </td>
                    <td>
                        <input type="text" ng-model="vm.creatorSupervisionFiles['REFERENCE'][$index]['description']" class="form-control" readonly>
                    </td>
                    <td align="center">
                        <button class="btn btn-danger btn-sm"
                            type="button"
                            mwl-confirm
                            title="Delete File"
                            message="Permanently delete <b>{{ additional.file_name }}</b>?"
                            confirm-text="Yes"
                            cancel-text="Cancel"
                            placement="top"
                            on-confirm="vm.deleteFile('REFERENCE', additional.id)"
                            confirm-button-type="danger"
                            cancel-button-type="default">Remove</button>
                    </td>
                </tr>

                <tr data-ng-repeat="additional in vm.newFilesIndex['REFERENCE']">
                    <td>
                        <h4>
                            Reference {{ $index + 1 + vm.creatorSupervisionFiles['REFERENCE'].length }}
                        </h4>
                    </td>
                    <td>
                        <div class="input-group">
                            <label class="input-group-btn">
                                <span class="btn btn-primary">
                                    Browse&hellip; <input type="file" style="display: none;" id="{{ $index }}" name="REFERENCE" onchange="angular.element(this).scope().setFiles(this)">
                                </span>
                            </label>
                            <input type="text" class="form-control" ng-model="vm.newFilesIndex['REFERENCE'][$index]['file']['name']" readonly>
                        </div>
                    </td>
                    <td>
                        <input type="text" ng-model="vm.newFilesIndex['REFERENCE'][$index]['description']" class="form-control">
                    </td>
                    <td align="center">
                        <button type="button" class="btn btn-sm btn-danger" ng-click="vm.removeFileInput($index, 'REFERENCE')">Remove</button>
                        <button type="button" class="btn btn-sm btn-primary" ng-show="vm.newFilesIndex['REFERENCE'][$index]['file'] != undefined && !vm.newApplication" ng-click="vm.uploadFile($index, 'REFERENCE')">Upload</button>
                    </td>
                </tr>

                <tr>
                    <td></td>
                    <td align="center">
                        <button type="button" class="add-fields btn btn-primary" ng-click="vm.addNewFileInput('REFERENCE')">Add Reference</button>
                    </td>
                    <td></td>
                    <td></td>
                </tr>


                <!-- Additional Material -->
                <tr ng-repeat="additional in vm.creatorSupervisionFiles['ADDITIONAL_MATERIAL'] track by additional.id">
                    <td>
                        <h4>
                            Additional Material {{ $index + 1 }}
                        </h4>
                    </td>
                    <td>
                        <a target="_blank" href="api/applications/download/?id={{ additional.id }}&token={{ vm.access_token }}"> {{ additional.file_name }} </a>
                    </td>
                    <td>
                        <input type="text" ng-model="vm.creatorSupervisionFiles['ADDITIONAL_MATERIAL'][$index]['description']" class="form-control" readonly>
                    </td>
                    <td align="center">
                        <button class="btn btn-danger btn-sm"
                            type="button"
                            mwl-confirm
                            title="Delete File"
                            message="Permanently delete <b>{{ additional.file_name }}</b>?"
                            confirm-text="Yes"
                            cancel-text="Cancel"
                            placement="top"
                            on-confirm="vm.deleteFile('ADDITIONAL_MATERIAL', additional.id)"
                            confirm-button-type="danger"
                            cancel-button-type="default">Remove</button>
                    </td>
                </tr>

                <tr data-ng-repeat="additional in vm.newFilesIndex['ADDITIONAL_MATERIAL']">
                    <td>
                        <h4>
                            Additional Material {{ $index + 1 + vm.creatorSupervisionFiles['ADDITIONAL_MATERIAL'].length }}
                        </h4>
                    </td>
                    <td>
                        <div class="input-group">
                            <label class="input-group-btn">
                                <span class="btn btn-primary">
                                    Browse&hellip; <input type="file" style="display: none;" id="{{ $index }}" name="ADDITIONAL_MATERIAL" onchange="angular.element(this).scope().setFiles(this)">
                                </span>
                            </label>
                            <input type="text" class="form-control" ng-value="vm.newFilesIndex['ADDITIONAL_MATERIAL'][$index]['file']['name']" readonly>
                        </div>
                    </td>
                    <td>
                        <input type="text" ng-model="vm.newFilesIndex['ADDITIONAL_MATERIAL'][$index]['description']" class="form-control">
                    </td>
                    <td align="center">
                        <button type="button" class="btn btn-sm btn-danger" ng-click="vm.removeFileInput($index, 'ADDITIONAL_MATERIAL')">Remove</button>
                        <button type="button" class="btn btn-sm btn-primary" ng-show="vm.newFilesIndex['ADDITIONAL_MATERIAL'][$index]['file'] != undefined && !vm.newApplication" ng-click="vm.uploadFile($index, 'ADDITIONAL_MATERIAL')">Upload</button>
                    </td>
                </tr>

                <tr>
                    <td></td>
                    <td align="center">
                        <button type="button" class="add-fields btn btn-primary" ng-click="vm.addNewFileInput('ADDITIONAL_MATERIAL')">Add Additional Material</button>
                    </td>
                    <td></td>
                    <td></td>
                </tr>

            </tbody>
        </table>

    </div>

    <h3>Research Administration</h3>

    <!-- Research Details -->
    <div class="form-group">
        <label for="exampleTextarea">Research Subject</label>
        <textarea class="form-control" id="research_subject" rows="1" ng-model="vm.application.research_subject"></textarea>
    </div>

    <div class="form-group">
        <label for="exampleTextarea">Registry Comment</label>
        <textarea class="form-control" id="registry_comment" rows="3" ng-model="vm.application.registry_comment"></textarea>
    </div>

    <br>

    <!-- Supervisors -->
    <label for="exampleTextarea">Potential Supervisors</label>

    <div class="input-group">
        <label class="input-group-btn">
            <button type="button" class="btn btn-primary" ng-click="vm.addCurrentlySelectedSupervisor()">Add</button>
        </label>

        <input type="text" ng-model="vm.currentlySelectedSupervisor" uib-typeahead="supervisorUsername for supervisorUsername in vm.supervisorUsernames | filter:$viewValue | limitTo:8" class="form-control" placeholder="E.g. mss" typeahead-show-hint="true" typeahead-min-length="1">
    </div>

    <br>

    <!-- Supervisions -->
    <div class="row supervision" ng-repeat="data in vm.supervisorSupervisions track by data.id">
        <supervision supervision="data" application-field-choices="vm.applicationFieldChoices" supervision-files="vm.supervisorSupervisionFiles[data.id]"></supervision>
        <button ng-show="!vm.newApplication"
                class="btn btn-danger btn-sm"
                type="button"
                mwl-confirm
                title="Delete {{ data.supervisor.username }}"
                message="Permanently delete this potential supervisor?"
                confirm-text="Yes"
                cancel-text="Cancel"
                placement="top"
                on-confirm="vm.deleteSupervision(data.id)"
                confirm-button-type="danger"
                cancel-button-type="default">Delete Supervision</button>
    </div>

    <!-- Temporary Supervisions -->
    <div class="row supervision" ng-repeat="temporarySupervisor in vm.temporarySupervisors">
        <b>{{ temporarySupervisor }}</b>
        <button type="button" class="btn btn-sm btn-danger" ng-click="vm.removeTemporarySupervisor(temporarySupervisor)">Delete Supervisor</button>
    </div>

    <br>

    <div class="form-group">
        <button ng-show="vm.newApplication" class="btn btn-primary btn-lg btn-block" type="submit">Submit</button>
        <button ng-show="!vm.newApplication"
                class="btn btn-danger btn-lg btn-block"
                type="button"
                mwl-confirm
                title="Delete {{ vm.application.registry_ref }}?"
                message="Are you sure you would like to permanently delete this application?"
                confirm-text="Yes, I am sure"
                cancel-text="Cancel"
                placement="top"
                on-confirm="vm.deleteApplication()"
                confirm-button-type="danger"
                cancel-button-type="default">Delete Application</button>
    </div>
</form>